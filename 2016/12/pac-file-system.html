<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>A PAC File System using Jekyll</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/font-awesome/css/all.min.css" />
  </head>
  <body>
    <div class="grid grid-cols-1 lg:grid-cols-layout gap-4">
      <div class="bg-white border-gray-200 border shadow-xl p-2 m-4 lg:mb-0 lg:mr-0 lg:col-start-2 text-center lg:text-left">
        <img src="/assets/profile.jpg" alt="Adam Laycock" class="m-auto" />
        <h2 class="font-light text-2xl">Adam Laycock</h2>
        
        <a href="/">Home</a>
        <a href="/blog/">All Posts</a>
        <a href="/about/">About</a>
        <a href="/uses/">Uses</a>
        <a href="/contact/">Contact</a>
      </div>
      <div class="lg:row-span-2">
        <section class="p-4 lg:pb-0 lg:pl-0">
          <div class="bg-white border-gray-300 border shadow-xl p-2 mb-4">
  <h1 class="font-light text-3xl border-b border-gray-200 mb-4">A PAC File System using Jekyll</h1>
  <ul class="flex gap-2">
    <li>20 December 2016</li>
    
      <li><a href="/tag/jekyll">#jekyll</a></li>
    
  </ul>
</div>
<div class="bg-white prose border-gray-300 border shadow-xl p-2"><p>A PAC (Proxy Auto-Config) File is a small javascript file that a browser can be configured to use when choosing a proxy server. For a few reasons over at <a href="https://www.ed-itsolutions.com/">Ed-IT Solutions</a>, we decided we needed a PAC file system to create these files for each school.</p>

<p>Normally a school’s ISP or filtering solution provides the PAC file but we have found issues with some due to them being too generic.</p>

<p>The one provided by <a href="https://www.censornet.com/solutions/education">Censor Net</a> is great, but it needs some exceptions. When using NTLM authentication on the proxy some programs (iTunes &amp; Java updater to name a couple) don’t use NTLM and instead prompt for a username and password. With complete control of the firewall, I can allow requests to Apple through without the proxy. I just need the PAC file to send Apple requests directly.</p>

<p>The <a href="http://www.btlancashire.co.uk/">BT Lancashire Services PAC</a> file is just plain awful. They have aimed for every school in one PAC file by using a huge if/else statement. That’s right there is currently an if with 53 else’s to decide which school you are and which port to use on the proxy server. I feel for the last school on the list who have to wait for 52 falses before it works out if they should use the proxy. When the school is found it then only uses the proxy for requests to google, youtube, and bing which doesn’t solve the SSL error for block pages. Even worse are the schools who use the PAC file but don’t need to, 53 falses then it returns DIRECT.</p>

<p><a href="http://cict.org.uk/">Cumbria ICT Centre</a> don’t provide one that I know of. This puts all the config into the browser which can be an issue with applications that can only take a basic proxy config.</p>

<h2 id="the-solution">The Solution</h2>

<p>We decided that our best solution was to create our own PAC file. Not wanting to repeat the mistakes of BT Lancashire Services we opted for a PAC file per school.</p>

<p>Generating a few static pages from even fewer templates sounds like a great job for Jekyll. Jekyll doesn’t care what you put into it. If it has a front matter it builds it, if it doesn’t Jekyll just copies it. There was a little hack needed to get the .htaccess to copy over neatly which you can find here.</p>

<p>Each school has a .pac file which has a front matter and no content. The front matter needs a few things set in it including:</p>

<ul>
  <li>Which template to use.</li>
  <li>The school’s name (for a comment at the top).</li>
  <li>The school’s domain name.</li>
  <li>The IP ranges in the school.</li>
  <li>The proxy server port (each school has their own port for BT LS).</li>
</ul>

<p>Jekyll then builds each PAC file like it would any page from the supplied layout. Not every variable is used in every layout and there are some pretty big differences between each.</p>

<p>I added a comment to the top of the PAC file with the git commit hash using this <a href="https://github.com/yegor256/jekyll-git-hash">Jekyll plugin</a> so we can see when caching is happening.</p>

<p>We then get GitLab CI to build the site for us on one of our web servers. Zero downtime deployments!</p>

<p>Having all our PAC files built from a list of templates saves the issues we have had in the past with PAC files hosted in the schools getting outdated.</p>

<h2 id="the-future">The Future</h2>

<p>This system is very flexible. Jekyll can have infinite templates or PAC files added to it with zero slowdowns. We won’t have to split schools between servers and try to balance any load as we are just serving static files.</p>

<p>For now, we are using it in a few test schools to ensure that our PAC files work as intended and the speed is as good as we expect.</p>

<p>Once we are happy we are going to roll it out to every school, even if they need no proxy settings. We have a template called direct which as you might have guessed returns DIRECT for every request. This allows a school to use a PAC file that does nothing so that if and when they change filtering solution we can change the template in the config and sit back as they suddenly start using a proxy server with no on site config changes.</p>
</div>
        </section>
        <footer class="mt-4 px-4 lg:px-0">
          &copy; Adam Laycock 2024
        </footer>
      </div>
    </div>
  </body>
</html>