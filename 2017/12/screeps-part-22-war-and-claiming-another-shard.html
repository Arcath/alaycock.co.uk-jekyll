<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/assets/512.png" />
    <title>Adam Laycock :: Screeps Part 22 – War and Claiming Another Shard</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/font-awesome/css/all.min.css" />
    <meta property="og:title" content="Adam Laycock / Screeps Part 22 – War and Claiming Another Shard" />
    <meta
      property="og:description"
      content="Pushing out into the map and other shards for profit."
    />
    <meta property="og:image" content="https://alaycock.co.uk/assets/og-image.png" />
  </head>
  <body>
    <div class="grid grid-cols-1 lg:grid-cols-layout gap-4">
      <div
        class="bg-white border-gray-200 border shadow-xl p-2 mt-4 mx-4 lg:col-start-2 lg:mx-0 text-center lg:text-left"
      >
        <img
          src="/assets/profile.jpg"
          alt="Adam Laycock"
          class="lg:m-auto w-32 float-left lg:float-none lg:w-full mr-4"
        />
        <h2 class="font-light text-2xl">Adam Laycock</h2>
        <h3 class="font-light text-lg">EdTech Network Manager & Developer</h3>

        <div class="grid grid-cols-3 gap-2 text-center mt-4">
          <a
            href="/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >Home</a
          >
          <a
            href="/blog/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >Posts</a
          >
          <a
            href="/talks/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >Talks</a
          >
          <a
            href="/about/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >About</a
          >
          <a
            href="/cv/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >CV</a
          >
          <a
            href="/uses/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >Uses</a
          >
          <a
            href="/contact/"
            class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none"
            >Contact</a
          >
        </div>
      </div>
      <div class="lg:row-span-2">
        <section class="p-4 lg:pb-0 lg:pl-0"><div class="bg-white border-gray-300 border shadow-xl p-2 mb-4">
  <h1 class="font-light text-3xl border-b border-gray-200 mb-4">Screeps Part 22 – War and Claiming Another Shard</h1>
  <ul class="flex gap-2">
    <li>20 December 2017</li>
    
      <li><a href="/tag/screeps">#screeps</a></li>
    
  </ul>
</div>
<div class="bg-white prose border-gray-300 border shadow-xl p-2"><p>This is part 22 of my Screeps story, you can read the whole story <a href="/tag/screeps">here</a>.</p>

<h2 id="war">War</h2>

<p>Rudykocur has been poking at me pretty hard the last few weeks and it’s not gone very well. My <a href="https://screeps.arcath.net/creep-designer/?share=14#0#0#8#7#6#0#0">new rangers</a> can win a one on one fight with <a href="https://screeps.arcath.net/creep-designer/?share=16#0#9#3#2#2#0#0">his attackers</a> no problem due to the way Screeps handles actions.</p>

<p><img src="/assets/2017/12/screeps-part-22-war-and-claiming-another-shard/action-priorities.png" alt="Action Priorities" /></p>

<p>The need for his creeps to self-heal meant that they could not attack. A creep can heal and use a ranged attack in the same tick which is why he could still fire at my creeps.</p>

<p>My creeps only use ranged attack parts which means they don’t reduce their damage whilst healing.</p>

<p>My problems come when he sends boosted creeps. These creeps can smash mine 1v1 and out heal a tower. I have some improved room defence code that has not yet been put to the test, I’m not going to describe it here until it has so that Rudykocur can’t prepare for it.</p>

<p>His creeps also went straight for the controller blocking my ability to safe mode, as a result I now have ramparts around the room controller so that an attacker can’t get to range 1.</p>

<p>His AI sends bosted creeps when it sees a spawn in the room. This lead to some frustration as my creeps would fight him off and defend long enough to build a spawn only to have boosted creeps come and wipe it.</p>

<p>My empire is now spread out with 16 rooms on the X-axis between 2 of my rooms. I had to optimise my claimer design so that they could get to the target before the TTL ran out and put a linear distance cap on my room pathfinder so it didn’t eat all my CPU.</p>

<h2 id="shard2">shard2</h2>

<p>I’d been debating claiming a room on shard0 for a while but none of the areas I could appear in felt friendly enough. When shard2 opened up I was ready to pounce and claimed one of the corner rooms next to the portal in shard2.</p>

<p><img src="/assets/2017/12/screeps-part-22-war-and-claiming-another-shard/shard2.png" alt="Shard2" /></p>

<p>The portal is rather close to Rudykocur but I’m hoping he won’t come through. If I can get my RCL up fast enough I should be able to prevent him getting a foothold.</p>

<p>My initial move onto shard2 was done without the <code class="language-plaintext highlighter-rouge">interShardSegment</code>. I simply had a flag on the portal which translated to send a claimer to this position. Once it appeared on shard2 the normal claim flag in absence of rooms to spawn the claimer from found the only creep and started a claim process for it. I repeated the same for building the first spawn which was a rather involved process. I definitely want to get inter-shard messaging working but I really wanted to get my first room up and running.</p>

<p>Inter-shard messaging presents a problem. The <code class="language-plaintext highlighter-rouge">interShardSegment</code> is a single memory segment that all shards have read-write access to. The problem here is that the shards have different tick rates and there is no system for preventing writes before reads etc….</p>

<p>The system I built to send messages works like this:</p>

<ol>
  <li>ShardX needs to write a message. It checks that the <code class="language-plaintext highlighter-rouge">interShardSegment</code> is empty and if it is it writes its message with a state of <code class="language-plaintext highlighter-rouge">STATE_WRITE</code>.</li>
  <li>ShardY may have a tick at this point and even if it is the recipient of the message it will ignore it for this tick.</li>
  <li>ShardX gets another tick and checks the message to ensure that the interShardSegment is as it left it. If it is it will change the state to <code class="language-plaintext highlighter-rouge">STATE_CONFIRMED</code>.</li>
  <li>Now ShardY will act on the message and when it is complete it will update its state to <code class="language-plaintext highlighter-rouge">STATE_READ</code>.</li>
  <li>ShardX sees that its message is now at <code class="language-plaintext highlighter-rouge">STATE_READ</code> and clears it.</li>
</ol>

<p>This ensures that the <code class="language-plaintext highlighter-rouge">interShardSegment</code> does not change whilst one shard is using it. If two shards write in the same tick only the last one to write will be able to confirm its message. Having the sending shard remove the message means I can do callbacks where the shard acts on completion of the job on another.</p>

<p>As I have already claimed a room on shard2 I don’t need to handle sending creeps over yet. For now, I am just sending status pings so that all my shards know about the others.</p>

<h2 id="i-like-the-way-you-move">I like the way you move()</h2>

<p>moveTo is not the best way to move your creeps. It generates a complete path but only stores the next few steps in memory causing a re-path in a few ticks. It avoids other creeps which can force creeps to take longer paths for no reason as the obstruction could have moved before they got there. This limited forward thinking comes into play when trying to move from one room to another where the direct path is blocked. I’ve had creeps walk into a wall and stay there because it went the wrong way entirely and got stuck down a dead end.</p>

<p>Replacing <code class="language-plaintext highlighter-rouge">moveTo</code> isn’t the easiest thing. I keep swapping to my new system whilst I can watch and back when I’m not.</p>

<p>The idea is to create a path using the PathFinder that uses a custom cost matrix which ignores creeps. The path is then turned into a string of directions that can be stored in memory. Each tick the creep simply moves in the direction at the beginning of the string. If it didn’t move it must be stuck, after 3 ticks of being stuck it will recalculate the path but this time include creeps in the cost matrix.</p>

<p>The functionality of moveTo is quite extensive and replacing it is going to take awhile. Early testing shows more CPU usage for the new process over the old one but I should be able to iron that out by caching paths. (e.g. harvesters moving from spawn to source etc…).</p>

<p>I’m still not 100% happy with my code and am running <code class="language-plaintext highlighter-rouge">moveTo</code> for now.</p>

<h2 id="improving-the-scheduler">Improving the Scheduler</h2>

<p>I was talking to postcrafter on the Overlords slack channel about our OSes and he pointed out that my <code class="language-plaintext highlighter-rouge">getHighestProcess</code> function might not be the most efficient way of working.</p>

<p>Currently, I filter and sort the process table every time its called which now that I have monitored the CPU usage accounts for 30-40% of my CPU each tick.</p>

<p>To improve this I now cache the sorted list until a new process is added. This has dropped its usage from 25-35 CPU per tick to 1-2. My bucket is now full most of the time instead of wavering around 4-6k as my CPU limiter keeps it topped up.</p>

<h2 id="bug-bash">Bug Bash</h2>

<p>I’ve has a few little bugs that are spamming my console output in the game. Now that I use source maps I’m wasting CPU translating stack traces which is something I’d like to avoid.</p>

<p>The solution is to fix the bugs which was rather easy. Most of them were issues with not having vision in a room so calls to <code class="language-plaintext highlighter-rouge">Game.getObjectById</code> would return null and not the source/controller.</p>

<h2 id="get-screeps">Get Screeps</h2>

<p>You can follow my progress on <a href="https://screeps.com/a/#!/profile/Arcath">my profile</a>. Once I reach RC4 I’m not sure how I am going to progress yet.</p>

<p>You can read more about Screeps on their <a href="https://screeps.com/">site</a>. I purchased it through steam giving me the permanent 10 CPU and the desktop client.</p>

<p>You can see my code as it was at the end of this post <a href="https://github.com/Arcath/screeps-code/tree/5371ff5f003f33aeb8c692a1529102ae2265fb5c">here</a>.</p>
</div></section>
        <footer class="mt-4 px-4 lg:px-0">
          &copy; Adam Laycock 2025
        </footer>
      </div>
    </div>
  </body>
</html>
