<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>wp_enqueue_less a replacement for WP-Less</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/font-awesome/css/all.min.css" />
  </head>
  <body>
    <div class="grid grid-cols-layout gap-4">
      <div class="bg-white border-gray-200 border shadow-xl p-2 mt-4 ml-4 col-start-2">
        <img src="/assets/profile.jpg" />
        <h2 class="font-light text-2xl">Adam Laycock</h2>
        
        <a href="/">Home</a>
        <a href="/blog/">All Posts</a>
        <a href="/about/">About</a>
        <a href="/uses/">Uses</a>
        <a href="/contact/">Contact</a>
      </div>
      <div class="row-span-2">
        <section class="pt-4 pr-4">
          <div class="bg-white border-gray-300 border shadow-xl p-2 mb-4">
  <h1 class="font-light text-3xl border-b border-gray-200 mb-4">wp_enqueue_less a replacement for WP-Less</h1>
  <ul class="flex gap-2">
    <li>06 July 2018</li>
    
      <li><a href="/tag/wordpress">#wordpress</a></li>
    
  </ul>
</div>
<div class="bg-white prose border-gray-300 border shadow-xl p-2"><p>I’ve used WP-Less for a couple of years now and been pretty happy with it, but on a couple of occasions I’ve had issues with it and with and the underlying <a href="https://github.com/leafo/lessphp">lessphp</a>.</p>

<p>There is a filter that can make it use the more upto date less.php instead but the fiter seemed to be ignored when I tried to use it.</p>

<p>This has lead me to having to build a replacement, which is something I’ve looked at on more than one occasion. With my replacement I want to:</p>

<ul>
  <li>Use less.php instead of lessphp</li>
  <li>Use composer properly and have the functions loaded through vendor/autoload.php.</li>
  <li>Only provide the function, if a theme or plugin wants less support they can use the composer module instead of installing a plugin.</li>
</ul>

<h2 id="wp_enqueue_less"><code class="language-plaintext highlighter-rouge">wp_enqueue_less</code></h2>

<p>I was surprised how easy this was to make. WP-Less has quite a lot of code and I assumed wrongly that it would take as much or more to do what I wanted. The current version (0.0.4) is only 91 lines of code and it ticks all my requirements.</p>

<p>There are 3 parts to <code class="language-plaintext highlighter-rouge">wp_enqueue_less</code>, the function called by the theme, an action to parse and cache the less file, and a wp-cron task to tidy up unused stylesheets.</p>

<p>Both the action and cron job are internal to <code class="language-plaintext highlighter-rouge">wp_enqueue_less</code> and should not be used by themes directly.</p>

<h3 id="the-function">The Function</h3>

<p>The function <code class="language-plaintext highlighter-rouge">wp_enqueue_less</code> takes 3 options.</p>

<ul>
  <li>key – The identifying key for this stylesheet.</li>
  <li>file – The on disk path of the stylesheet (e.g. <code class="language-plaintext highlighter-rouge">get_template_directory() . '/style.less'</code>)</li>
  <li>variables  – An array of variables to pass to the less compiler. The array should take for form variableName =&gt; value.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">add_action</span><span class="p">(</span><span class="s1">'wp_enqueue_scripts'</span><span class="p">,</span> <span class="k">function</span><span class="p">(){</span>
  <span class="nf">wp_enqueue_less</span><span class="p">(</span><span class="s1">'theme-main'</span><span class="p">,</span> <span class="nf">get_template_directory</span><span class="p">()</span> <span class="mf">.</span> <span class="s1">'/less/main.less'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'main-color'</span> <span class="o">=&gt;</span> <span class="s1">'#99bbff'</span> <span class="c1">// Becomes @main-color in your less stylesheet</span>
  <span class="p">));</span>
<span class="p">});</span>
</code></pre></div></div>

<p>As mentioned in my original post about wp-less I get my variables from the theme customizer. If you need a way of interacting with the theme customiser my <a href="/2017/03/theme-options/">theme options</a> library is a great place to start.</p>

<p>The fuction then fetches its data about the stylesheet from the database. If it doesn’t have any it calls the less compile action to compile the stylesheet and build up the data object.</p>

<p>If it does have data it then begins some comparisons. It first checks if the variables have been changed by hashing them and comparing them to the stored hash. If they have changed the action is called, if they haven’t it continues on.</p>

<p>Next it compares the file hashes of all the included less files, if any of them have changed it will call the action, if not it continues.</p>

<p>At this point either the stylesheet is new and got built, changed and got built or remained the same and should exist in the cache directory already. All that is left is to call wp_enqueue_style to queue up the cached stylesheet.</p>

<p>Lastly it ensures that the cron job exists.</p>

<h2 id="the-action">The Action</h2>

<p>The action takes 2 options.</p>

<ul>
  <li>The internal data object for the stylesheet</li>
  <li>An array of variables.</li>
</ul>

<p>It’s then a simple process of using less.php to compile the stylesheet and save the outputted css to a css file in the uploads directory.</p>

<p>It then saves the hash, the file hashes and the variables hash to the data object and returns.</p>

<h2 id="the-cron-job">The Cron Job</h2>

<p>Because <code class="language-plaintext highlighter-rouge">wp_enqueue_less</code> writes a css file for each hash (to browser cache bust) if left unchecked it could fill up your webserver with random css files. The cron job solves this by  going through the output folder and deleting all files other than the current file for each stylesheet key.</p>

<h2 id="use-it">Use it</h2>

<p><code class="language-plaintext highlighter-rouge">wp_enqueue_less</code> has been released through the Ed-IT Solutions Git Hub org as an open source library and is availbe on composer as <code class="language-plaintext highlighter-rouge">ed-itsolutions/wp_enqueue_less</code>. You can install it quickly using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>composer require ed-itsolutions.wp_enqueue_less
</code></pre></div></div>

<p>Require composers autoload like normal and thats it, you now have the function wp_enqueue_less.</p>

<p>There are 2 filters that changed the directory of the cached css files.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">wp_enqueue_less_css_dir</code> – Needs to return the on disk path to the less css cache. Defaults to wp-content/uploads/less</li>
  <li><code class="language-plaintext highlighter-rouge">wp_enqueue_less_css_url</code> – Needs to return the URL of the less css folder.</li>
</ul>

<p>I’ve swapped most of our themes over to <code class="language-plaintext highlighter-rouge">wp_enqueue_less</code> without much hassle and will be using and updating it for all our themes.</p>
</div>
        </section>
        <footer class="mt-4">
          &copy; Adam Laycock 2024
        </footer>
      </div>
    </div>
  </body>
</html>