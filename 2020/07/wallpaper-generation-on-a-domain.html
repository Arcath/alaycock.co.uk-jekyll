<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/assets/512.png" />
    <title>Wallpaper Generation on a Domain</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/font-awesome/css/all.min.css" />
    <meta property="og:title" content="Adam Laycock / Wallpaper Generation on a Domain" />
    <meta property="og:description" content="Getting wallpapers and lock screens deployed to all your computers." />
    <meta property="og:image" content="https://alaycock.co.uk/assets/og-image.png" />
  </head>
  <body>
    <div class="grid grid-cols-1 lg:grid-cols-layout gap-4">
      <div class="bg-white border-gray-200 border shadow-xl p-2 mt-4 mx-4 lg:col-start-2 lg:mx-0 text-center lg:text-left">
        <img src="/assets/profile.jpg" alt="Adam Laycock" class="lg:m-auto w-32 float-left lg:float-none lg:w-full mr-4" />
        <h2 class="font-light text-2xl">Adam Laycock</h2>
        <h3 class="font-light text-lg">EdTech Network Manager & Developer</h3>
        
        <div class="grid grid-cols-3 gap-2 text-center mt-4">
          <a href="/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">Home</a>
          <a href="/blog/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">Posts</a>
          <a href="/talks/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">Talks</a>
          <a href="/about/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">About</a>
          <a href="/uses/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">Uses</a>
          <a href="/contact/" class="bg-gray-200 p-2 shadow border border-gray-300 hover:shadow-none">Contact</a>
        </div>
      </div>
      <div class="lg:row-span-2">
        <section class="p-4 lg:pb-0 lg:pl-0">
          <div class="bg-white border-gray-300 border shadow-xl p-2 mb-4">
  <h1 class="font-light text-3xl border-b border-gray-200 mb-4">Wallpaper Generation on a Domain</h1>
  <ul class="flex gap-2">
    <li>27 July 2020</li>
    
      <li><a href="/tag/powershell">#powershell</a></li>
    
      <li><a href="/tag/gpo">#gpo</a></li>
    
  </ul>
</div>
<div class="bg-white prose border-gray-300 border shadow-xl p-2"><p>I’ve been spending a bit of time recently thinking about wallpapers and lock screens for domain computers. For a long time I’ve used a static image for the computer’s lock screen and then <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/bginfo">BGInfo</a> for the user’s wallpaper. The problem is that, at least in my experience, BGInfo seems to fail for everyone’s first logon to a machine. This leaves users with the default Windows 10 wallpaper which isn’t bad, but it isn’t the branded photo they should be getting.</p>

<p>So to cut a long story short I decided it was time to find a new way of doing wallpapers, and ideally creating a lock screen image with the computer’s hostname on it.</p>

<h2 id="powershell">PowerShell</h2>

<p>PowerShell is what I wanted to solve this issue with. I knew it could modify images and figured it could be used for this. Logon and Startup scripts have been pretty reliable for me in the past so I wanted to bring that reliability to this problem.</p>

<p>As with all things I hopped on Google before I started and found <a href="http://www.edugeek.net/blogs/dj-1701/2342-boot-logon-wallpaper-generation-using-powershell.html">this post on EduGeek</a> giving me exactly what I needed. Following on from that the author had created a <a href="https://github.com/DJ-1701/GenerateWallpaper">GitHub repository</a> with their latest code in. With some minor tweaks to the code I got it to spit out an image which was great but it didn’t work quite as well as I wanted.</p>

<p>The first issue I had with it was purely cosmetic, a transparent box background was not an option. As we had one image to work with it’s easy to pick a suitably contrasting colour.</p>

<p>The second problem was that it needed you to edit the <code class="language-plaintext highlighter-rouge">.ps1</code> file to change the settings. Not an issue for me but within <a href="https://www.ed-itsolutions.com">Ed-IT Solutions</a> I like to operate a <em>no code edits</em> system where scripts always take no more than 2 or 3 options to do a job.</p>

<p>What I’m leading up to here is that I’ve created <a href="https://github.com/Ed-ITSolutions/wallpaper-scripts">my own script</a>. Full Credit to <a href="https://github.com/DJ-1701">DJ-1701</a> for their original work, its safe to say I wouldn’t have this script working as well as it does without the leg up they gave me.</p>

<p>The big difference is the way it accepts config. My script uses a <code class="language-plaintext highlighter-rouge">.ini</code> file like the one below to configure the output.</p>

<p>I also swapped out the system for getting the screen resolution to one that uses a WMI query. Might be less reliable than the original method but all my test machines haven’t had an issue with it, and it works both at boot and during logon removing the need to dump the values into registry.</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[files]</span>
<span class="c">; Background image to use. @@ is replaced with the scripts execution point. ## is replaced with the temp directory
</span><span class="py">inputImage</span> <span class="p">=</span> <span class="s">"@@</span><span class="se">\w</span><span class="s">allpaper.jpg"</span>
<span class="py">outputImage</span> <span class="p">=</span> <span class="s">"##</span><span class="se">\u</span><span class="s">ser.jpg"</span>
<span class="c">; Apply the image as the current users wallpaper. 1 for yes, 0 for no
</span><span class="py">applyToUser</span> <span class="p">=</span> <span class="s">1</span>
<span class="nn">[header]</span>
<span class="c">; The text to display, use # to create a new line.
; Variables:
;  %user - The current username.
;  %computer - The Computers Hostname.
;  %time - The time at generation, time of logon or boot
</span><span class="py">text</span> <span class="p">=</span> <span class="s">Ed-IT Solutions (UK) Ltd.##User: %user#Computer: %computer</span>
<span class="py">textSize</span> <span class="p">=</span> <span class="s">12</span>
<span class="py">textRed</span> <span class="p">=</span> <span class="s">255</span>
<span class="py">textGreen</span> <span class="p">=</span> <span class="s">255</span>
<span class="py">textBlue</span> <span class="p">=</span> <span class="s">255</span>
<span class="py">textAlpha</span> <span class="p">=</span> <span class="s">255</span>
<span class="py">boxRed</span> <span class="p">=</span> <span class="s">0</span>
<span class="py">boxGreen</span> <span class="p">=</span> <span class="s">0</span>
<span class="py">boxBlue</span> <span class="p">=</span> <span class="s">0</span>
<span class="py">boxAlpha</span> <span class="p">=</span> <span class="s">0</span>
<span class="c">; Allowed values left,center,right
</span><span class="py">alignment</span> <span class="p">=</span> <span class="s">right</span>
<span class="nn">[footer]</span>
<span class="c">; Same as header.text
</span><span class="py">text</span> <span class="p">=</span> <span class="s">Logged On: %time</span>
<span class="py">alignment</span> <span class="p">=</span> <span class="s">left</span>
</code></pre></div></div>

<p>The above file would create an image and apply it to the current user’s wallpaper. Setting <code class="language-plaintext highlighter-rouge">applyTouser</code> to <code class="language-plaintext highlighter-rouge">0</code> would turn this off and have it only save the output to a file.</p>

<p>There is an example <a href="https://github.com/Ed-ITSolutions/wallpaper-scripts/blob/master/logon.ini">logon.ini</a> and <a href="https://github.com/Ed-ITSolutions/wallpaper-scripts/blob/master/boot.ini">boot.ini</a> in the repository.</p>

<p>This gives a single script to run both lock screens and wallpapers as its simply down to the ini file used. To supply an ini file the script takes an option of <code class="language-plaintext highlighter-rouge">-ini &lt;path&gt;</code> where <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> is the path to the ini file.</p>

<h2 id="group-policy">Group Policy</h2>

<p>The scripts are only half of the battle, getting it out to every computer is just as important.</p>

<p>As with BGInfo I used GPP Files to copy <code class="language-plaintext highlighter-rouge">wallpaper.ps1</code>, <code class="language-plaintext highlighter-rouge">logon.ini</code>, <code class="language-plaintext highlighter-rouge">boot.ini</code> and <code class="language-plaintext highlighter-rouge">wallpaper.jpg</code> to the C drive of every computer. In my case I always have a folder in the root of C that matches the domain name, so <code class="language-plaintext highlighter-rouge">arcath.net</code> would become <code class="language-plaintext highlighter-rouge">C:\Arcath</code> which is I where I copied them to.</p>

<p>PowerShell needs some setup before it can run scripts without warnings. In a GPO I set <em>Computer Configuration / Policies / Administrative Templates / Windows PowerShell / Turn on Script Execution</em> to <em>Allow local scripts and remote signed scripts</em>. This is where copying the scripts to each machine becomes nessasary as if you run them out of <code class="language-plaintext highlighter-rouge">NETLOGON</code> they would need to be signed.</p>

<blockquote>
  <p>If you download the script directly from GitHub you might find that Windows flags it as a remote script even if its copied to each computer. You can fix this by going into properties of the script on the server and ticking <em>Unblock</em></p>
</blockquote>

<p><img src="/assets/2020/07/wallpaper-generation-on-a-domain/unblock.png" alt="Unblock the file" /></p>

<p>Once all the files are deployed its then a simple matter to use a GPO to add a Start-up and Logon <em>PowerShell</em> script. I found that trying to use <code class="language-plaintext highlighter-rouge">$PSScriptRoot</code> doesn’t work as expected in start-up and logon which resulting in errors. So whilst there is an option to use it in the file paths I don’t and instead specify the full path to the wallpaper. <code class="language-plaintext highlighter-rouge">##</code> to use the temp directory works fine which I use in the output of users wallpapers.</p>

<p>With all that I’m now getting reliable images generated every logon and startup.</p>

<h2 id="examples">Examples</h2>

<p>Some examples of the output.</p>

<p>A Lock Screen:</p>

<p><img src="/assets/2020/07/wallpaper-generation-on-a-domain/lock.jpg" alt="Excuse the default hostname" /></p>

<p>A users wallpaper:</p>

<p><img src="/assets/2020/07/wallpaper-generation-on-a-domain/user.jpg" alt="Logged onto a server" /></p>
</div>
        </section>
        <footer class="mt-4 px-4 lg:px-0">
          &copy; Adam Laycock 2024
        </footer>
      </div>
    </div>
  </body>
</html>